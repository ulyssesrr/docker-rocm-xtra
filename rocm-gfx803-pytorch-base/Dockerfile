ARG UBUNTU_VERSION
ARG ROCM_ARCH
ARG ROCM_MAJOR_VERSION
ARG ROCM_MINOR_VERSION
ARG ROCM_PATCH_VERSION
ARG ROCM_BUILD_NUMBER
ARG ROCM_LIBPATCH_VERSION
ARG ROCM_VERSION
ARG MAGMA_VERSION
ARG ROCBLAS_BASE_URL
ARG ROCBLAS_FILE
ARG ROCBLAS_DEV_FILE
ARG PYTHON_VERSION
ARG PYTORCH_VERSION
ARG PYTORCH_VISION_VERSION
ARG OPENCV_VERSION
ARG GFX803_DIST_BASE_URL
ARG GFX803_DIST_TORCH_WHEEL
ARG GFX803_DIST_TORCHVISION_WHEEL
ARG NUM_CPU_CORES

ARG OPENBLAS_VERSION
ARG OPENBLAS_INSTALL_PREFIX

FROM ulyssesrr/rocm-gfx803-dev:ubuntu${UBUNTU_VERSION}-rocm${ROCM_VERSION}-complete

ARG UBUNTU_VERSION
ARG ROCM_ARCH
ARG ROCM_MAJOR_VERSION
ARG ROCM_MINOR_VERSION
ARG ROCM_PATCH_VERSION
ARG ROCM_BUILD_NUMBER
ARG ROCM_LIBPATCH_VERSION
ARG ROCM_VERSION
ARG MAGMA_VERSION
ARG ROCBLAS_BASE_URL
ARG ROCBLAS_FILE
ARG ROCBLAS_DEV_FILE
ARG PYTHON_VERSION
ARG PYTORCH_VERSION
ARG PYTORCH_VISION_VERSION
ARG OPENCV_VERSION
ARG GFX803_DIST_BASE_URL
ARG GFX803_DIST_TORCH_WHEEL
ARG GFX803_DIST_TORCHVISION_WHEEL
ARG NUM_CPU_CORES

ARG OPENBLAS_VERSION
ARG OPENBLAS_INSTALL_PREFIX

LABEL org.opencontainers.image.authors="Ulysses R. Ribeiro <ulyssesrr@gmail.com>"

# build OpenBLAS
WORKDIR /git
RUN git clone --depth 1 --branch v${OPENBLAS_VERSION} https://github.com/xianyi/OpenBLAS.git
WORKDIR /git/OpenBLAS
RUN make USE_OPENMP=1 DYNAMIC_ARCH=1 NO_AFFINITY=1 NUM_THREADS=64 CORE=CORE2 NO_WARMUP=1 BUILD_TESTING=0
RUN make install PREFIX=${OPENBLAS_INSTALL_PREFIX}

# pytorch expected env var
ENV OpenBLAS_HOME=${OPENBLAS_INSTALL_PREFIX}

# magma deps
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    gfortran \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /git
RUN git clone --depth 1 --branch v${MAGMA_VERSION} https://bitbucket.org/icl/magma.git
WORKDIR /git/magma

# prepare magma build
RUN cp make.inc-examples/make.inc.hip-gcc-openblas make.inc

# set magma GPU target
ENV GPU_TARGET=${ROCM_ARCH}

# tell magma where OpenBLAS is located
ENV OPENBLASDIR=${OPENBLAS_INSTALL_PREFIX}

# hipify magma source files
RUN make -f make.gen.hipMAGMA

# set target for hipcc
ENV HCC_AMDGPU_TARGET=${ROCM_ARCH}

# build magma lib
RUN make lib sparse-lib -j${NUM_CPU_CORES}

# install (default: /usr/local/magma)
RUN make install

# DEBUG
RUN make testing/testing_dgemm

